#!/usr/bin/env bash
set -euo pipefail

# ------------------------------------------------------------------
# Scripthub Bootstrap + Entry Point (Modular)
# ------------------------------------------------------------------

REPO_URL="https://github.com/HYP3R00T/scripthub"
INSTALL_DIR="$HOME/.local/share/scripthub"
LAUNCHER="$INSTALL_DIR/scripthub"

# ------------------------------------------------------------------
# Functions
# ------------------------------------------------------------------

check_mise() {
	if ! command -v mise >/dev/null 2>&1; then
		echo "âš ï¸  'mise' not found! Installing..."
		curl -fsSL https://mise.run | sh
		export PATH="$HOME/.local/bin:$PATH"
		echo "âœ… 'mise' installed!"
	fi
}

install_gum() {
	if ! command -v gum >/dev/null 2>&1; then
		echo "âš ï¸  'gum' not found! Installing via mise..."
		mise install charmbracelet/gum
		echo "âœ… 'gum' installed!"
	fi
}

clone_repo_if_missing() {
	if [[ ! -d "$INSTALL_DIR" ]]; then
		echo "ðŸ“¦ Scripthub not found in $INSTALL_DIR â€” cloning..."
		git clone "$REPO_URL" "$INSTALL_DIR"
		chmod +x "$LAUNCHER"
		echo "âœ… Scripthub installed!"
	fi
}

add_to_path_file() {
	local rc_file=$1
	if [[ -f "$rc_file" ]] && ! grep -q "$INSTALL_DIR" "$rc_file"; then
		echo "export PATH=\"$INSTALL_DIR:\$PATH\"" >>"$rc_file"
		echo "âœ… Updated $rc_file"
	fi
}

ensure_path() {
	if [[ ":$PATH:" != *":$INSTALL_DIR:"* ]]; then
		echo "ðŸŸ¢ Adding $INSTALL_DIR to PATH in shell config files..."
		add_to_path_file "$HOME/.bashrc"
		add_to_path_file "$HOME/.zshrc"
		export PATH="$INSTALL_DIR:$PATH"
		echo "âœ… Updated PATH for current session"
	fi
}

resolve_base_dir() {
	local source="${BASH_SOURCE[0]}"
	while [ -L "$source" ]; do
		local dir
		dir="$(cd -P "$(dirname "$source")" && pwd)"
		source="$(readlink "$source")"
		[[ $source != /* ]] && source="$dir/$source"
	done
	BASE_DIR="$(cd -P "$(dirname "$source")" && pwd)"
	SCRIPT_DIR="$BASE_DIR/scripts"
}

source_modules() {
	# shellcheck disable=SC1091
	source "$SCRIPT_DIR/runner.sh"
	# shellcheck disable=SC1091
	source "$SCRIPT_DIR/add.sh"
	# shellcheck disable=SC1091
	source "$SCRIPT_DIR/help.sh"
}

dispatch_command() {
	local cmd="${1:-run}"
	shift || true

	case "$cmd" in
	run | list)
		handle_runner "$cmd" "$@"
		;;
	add)
		handle_add "$@"
		;;
	help | --help | -h)
		show_help
		;;
	*)
		echo "Usage: $0 {run|list|add <file>|help}" >&2
		exit 1
		;;
	esac
}

# ------------------------------------------------------------------
# Main
# ------------------------------------------------------------------
main() {
	check_mise
	install_gum
	clone_repo_if_missing
	ensure_path
	resolve_base_dir
	source_modules
	dispatch_command "$@"
}

main "$@"
